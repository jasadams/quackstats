# name: test/sql/quackstats.test
# group: quackstats

require quackstats

# Create a test table with a simple linear upward trend
statement ok
CREATE TABLE test_linear AS
SELECT ('2025-01-01'::DATE + INTERVAL (i) DAY)::DATE AS ds,
       100.0 + i * 2.0 AS revenue
FROM generate_series(0, 29) t(i);

# Verify test data was created
query I
SELECT count(*) FROM test_linear;
----
30

# Basic forecast call returns the expected number of rows (horizon + 1 anchor row)
query I
SELECT count(*) FROM forecast('test_linear', timestamp = 'ds', value = 'revenue', horizon = 5);
----
6

# Forecast output has correct column names and types
query TRRR
SELECT typeof(forecast_timestamp), typeof(forecast), typeof(lower_bound), typeof(upper_bound)
FROM forecast('test_linear', timestamp = 'ds', value = 'revenue', horizon = 1)
LIMIT 1;
----
DATE	DOUBLE	DOUBLE	DOUBLE

# Forecast timestamps should be after the last date in the source data (2025-01-30)
# (skip the anchor row which equals the last date)
query T
SELECT forecast_timestamp > '2025-01-30'::DATE
FROM forecast('test_linear', timestamp = 'ds', value = 'revenue', horizon = 1)
ORDER BY forecast_timestamp DESC LIMIT 1;
----
true

# Forecast for linear upward trend should produce increasing values
# (the point forecast for the next day should be > the last value of ~158)
query T
SELECT forecast > 100.0
FROM forecast('test_linear', timestamp = 'ds', value = 'revenue', horizon = 1)
ORDER BY forecast_timestamp DESC LIMIT 1;
----
true

# Lower bound should be <= forecast, upper bound should be >= forecast
query TT
SELECT lower_bound <= forecast, upper_bound >= forecast
FROM forecast('test_linear', timestamp = 'ds', value = 'revenue', horizon = 1)
ORDER BY forecast_timestamp DESC LIMIT 1;
----
true	true
